-- Full LocalScript: ScreenBlack + Webhook log + Rayfield UI + FastAttack V1/V2 + AntiAFK + AntiKick + AutoRejoin
-- Dán vào StarterPlayer -> StarterPlayerScripts

-- === CẤU HÌNH ===
local WEBHOOK_URL = "https://discord.com/api/webhooks/xxxxxxxxxx/xxxxxxxxxx" -- Thay webhook của ông ở đây
local REJOIN_PLACE_ID = 4587545091 -- place id để auto rejoin

-- === SERVICES ===
local Players = game:GetService("Players")
local HttpService = game:GetService("HttpService")
local TweenService = game:GetService("TweenService")
local TeleportService = game:GetService("TeleportService")

local LocalPlayer = Players.LocalPlayer

-- === SEND WEBHOOK (NON-BLOCKING) ===
task.spawn(function()
    if WEBHOOK_URL and WEBHOOK_URL ~= "" then
        local ok, json = pcall(function()
            local embed = {
                ["username"] = "Script Logger",
                ["embeds"] = {{
                    ["title"] = "Người vừa chạy script",
                    ["description"] = "**Tên:** " .. tostring(LocalPlayer.Name)
                                  .. "\n**DisplayName:** " .. tostring(LocalPlayer.DisplayName)
                                  .. "\n**UserId:** " .. tostring(LocalPlayer.UserId)
                                  .. "\n**Thời gian:** " .. os.date("%Y-%m-%d %H:%M:%S"),
                    ["color"] = 16711680
                }}
            }
            return HttpService:JSONEncode(embed)
        end)

        if ok and json then
            pcall(function()
                -- PostAsync đôi khi cần Enum, nhưng nhiều executor chấp nhận 2 tham số
                HttpService:PostAsync(WEBHOOK_URL, json)
            end)
        end
    end
end)

-- === ANTI AFK V2 ===
task.spawn(function()
    -- Một số executor mới có VirtualInputManager, một số thì không. Dùng pcall để tránh lỗi.
    if game.PlaceId ~= 9821272782 then
        local success = pcall(function()
            getgenv().Press = function(v)
                return game:GetService("VirtualInputManager"):SendKeyEvent(true, v, false, game)
            end
        end)
        if success and getgenv().Press then
            while task.wait(10.5) do
                pcall(function() Press("RightBracket") end) -- phím ]
            end
        else
            -- Fallback: chỉ idle nhẹ (không mạnh như VM)
            while task.wait(10.5) do
                -- nothing, giữ vòng để không dừng. (executor không hỗ trợ VM)
            end
        end
    else
        -- Trường hợp game.PlaceId == 9821272782 (theo script gốc) dùng keypress
        while task.wait(10.5) do
            pcall(function()
                if type(keypress) == "function" then
                    keypress(0xDD)
                end
            end)
        end
    end
end)

-- === ANTI KICK (hook __namecall) ===
local successHook = pcall(function()
    local mt = getrawmetatable(game)
    local oldNamecall = mt.__namecall
    setreadonly(mt, false)
    mt.__namecall = newcclosure(function(self, ...)
        local method = getnamecallmethod()
        if method == "Kick" or method == "kick" then
            return nil -- chặn
        end
        return oldNamecall(self, ...)
    end)
    setreadonly(mt, true)
end)
-- nếu hook không thành công thì vẫn tiếp tục (có thể executor không cho phép)

-- === AUTO REJOIN KHI BỊ KICK / TELEPORT FAIL ===
-- Kết hợp xử lý Kicked event (nếu có) và TeleportState
pcall(function()
    LocalPlayer.Kicked:Connect(function()
        pcall(function()
            TeleportService:Teleport(REJOIN_PLACE_ID, LocalPlayer)
        end)
    end)
end)

pcall(function()
    LocalPlayer.OnTeleport:Connect(function(State)
        if State == Enum.TeleportState.Failed then
            pcall(function()
                TeleportService:Teleport(REJOIN_PLACE_ID, LocalPlayer)
            end)
        end
    end)
end)

-- === MÀN HÌNH ĐEN + CHỮ TỪ TỪ ===
local screenGui = Instance.new("ScreenGui")
screenGui.Parent = LocalPlayer:WaitForChild("PlayerGui")
screenGui.IgnoreGuiInset = true
screenGui.ResetOnSpawn = false

local blackFrame = Instance.new("Frame")
blackFrame.Name = "BlackCover"
blackFrame.BackgroundColor3 = Color3.new(0,0,0)
blackFrame.Size = UDim2.new(1,0,1,0)
blackFrame.AnchorPoint = Vector2.new(0,0)
blackFrame.Position = UDim2.new(0,0,0,0)
blackFrame.Parent = screenGui

local textLabel = Instance.new("TextLabel")
textLabel.Size = UDim2.new(1,0,1,0)
textLabel.BackgroundTransparency = 1
textLabel.TextColor3 = Color3.new(1,1,1)
textLabel.Font = Enum.Font.SourceSansBold
textLabel.TextScaled = true
textLabel.TextWrapped = true
textLabel.Text = ""
textLabel.Parent = blackFrame
textLabel.TextYAlignment = Enum.TextYAlignment.Center
textLabel.TextXAlignment = Enum.TextXAlignment.Center

local message = "Bạn là người thông minh"
for i = 1, #message do
    textLabel.Text = string.sub(message, 1, i)
    task.wait(0.08) -- tốc độ gõ chữ
end

task.wait(1.2)
local tw = TweenService:Create(blackFrame, TweenInfo.new(0.9, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {BackgroundTransparency = 1})
tw:Play()
tw.Completed:Wait()
screenGui:Destroy()

-- === RAYFIELD UI + FAST ATTACK ===
local okRay, Rayfield = pcall(function()
    return loadstring(game:HttpGet('https://sirius.menu/rayfield'))()
end)

if not okRay or not Rayfield then
    -- Nếu không load được Rayfield thì thông báo console và dừng phần UI (nhưng core vẫn chạy)
    warn("Rayfield load failed, UI không hiển thị.")
    -- vẫn tiếp tục để Fast Attack không phụ thuộc UI (nếu muốn)
else
    local Window = Rayfield:CreateWindow({
       Name = "Script Test",
       Icon = 0,
       LoadingTitle = "Rayfield Interface Suite",
       LoadingSubtitle = "by CongThien2025",
       ShowText = "Rayfield",
       Theme = "Default",
       ToggleUIKeybind = "K",
       DisableRayfieldPrompts = false,
       DisableBuildWarnings = false,
       ConfigurationSaving = { Enabled = true, FolderName = nil, FileName = "Big Hub" },
       Discord = { Enabled = false, Invite = "noinvitelink", RememberJoins = true },
       KeySystem = false,
       KeySettings = { Title = "Untitled", Subtitle = "Key System", Note = "No method of obtaining the key is provided", FileName = "Key", SaveKey = true, GrabKeyFromSite = false, Key = {"Hello"} }
    })

    local MainTab = Window:CreateTab("Home", nil)
    MainTab:CreateSection("Main")

    -- trạng thái toggle
    local fastV1 = false
    local fastV2 = false

    -- Fast Attack V1: 0.1s
    MainTab:CreateToggle({
       Name = "Fast Attack V1 (0.1s)",
       CurrentValue = false,
       Flag = "FastV1",
       Callback = function(Value)
          fastV1 = Value
       end,
    })

    -- Fast Attack V2: 0.08s
    MainTab:CreateToggle({
       Name = "Fast Attack V2 (0.08s)",
       CurrentValue = false,
       Flag = "FastV2",
       Callback = function(Value)
          fastV2 = Value
       end,
    })

    -- Option: nút test nhỏ
    MainTab:CreateButton({
       Name = "Test Remote Fire",
       Callback = function()
          local char = LocalPlayer.Character
          if char then
              local tool = char:FindFirstChildOfClass("Tool")
              if tool then
                  local remote = tool:FindFirstChild("Hitbox")
                  if remote and remote:IsA("RemoteEvent") then
                      pcall(function() remote:FireServer() end)
                  end
              end
          end
       end
    })

    -- Loop V1
    task.spawn(function()
        while task.wait(0.1) do -- 0.1s cho V1
            if fastV1 then
                local char = LocalPlayer.Character
                if char then
                    local tool = char:FindFirstChildOfClass("Tool")
                    if tool then
                        local remote = tool:FindFirstChild("Hitbox")
                        if remote and remote:IsA("RemoteEvent") then
                            pcall(function() remote:FireServer() end)
                        end
                    end
                end
            end
        end
    end)

    -- Loop V2
    task.spawn(function()
        while task.wait(0.08) do -- 0.08s cho V2
            if fastV2 then
                local char = LocalPlayer.Character
                if char then
                    local tool = char:FindFirstChildOfClass("Tool")
                    if tool then
                        local remote = tool:FindFirstChild("Hitbox")
                        if remote and remote:IsA("RemoteEvent") then
                            pcall(function() remote:FireServer() end)
                        end
                    end
                end
            end
        end
    end)
end

-- === Extra safety console info ===
print("[Script] Loaded: ScreenBlack + Webhook + FastAttack V1/V2 + AntiAFK + AntiKick + AutoRejoin")
